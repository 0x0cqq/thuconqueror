# 程序设计实训——战棋大作业文档

软件03 陈启乾 2020012385

[TOC]

## Git 仓库

https://github.com/ChenQiqian/thuconqueror

### 编译注意

可以使用 Qt Creator 编译。

编译完成后需要把主文件夹下的 json 文件夹移动到可执行文件所在的文件夹。

## 游戏设定

### 游戏名称

疫情防控保卫战战棋

### 游戏背景

在 0202 年，全球爆发了肺炎疫情。这场疫情直至 1202 年 8 月仍未结束。C 国重要高等学府 T 大，疫情防控 T 大保卫战一触即发。

现在假如你是 T 大校长 Q Boss，请你来指挥学校，与病毒战斗吧！

## 游戏流程

运行游戏可执行程序，进入游戏开始界面后，点击“开始游戏”，进入关卡选择界面；

在关卡选择界面点击对应关卡的“开始”按钮，进入对应的关卡。

在游戏界面，滚轮可以缩放游戏界面，（缩放较大时）鼠标右键可以拖动游戏界面，左键点击地图可以选中单元格 / 兵进行操作。

在游戏界面，类似帐篷的地形是人类营地，类似裂缝的地形是病毒营地，只有营地可以生产对应的方面的兵种；营地是唯一有血量的单元，当一方所有营地的血量均降到 0 及以下，则该方会被判定为输。

玩家可以点击人类营地的帐篷单元，随后点击最下侧的“新建兵”按钮新建兵。玩家只能在血量大于 0 的，且当前格子上没有单元的本方营地上新建单元。

单元在最初新建的回合不能移动，在之后的每个回合均有一次移动或一次攻击的机会。玩家移动后可以进攻，但进攻后不能移动。单元的进攻范围均为 1 。如果单元周围有绿色的圆圈 gif，代表该单元仍能攻击或移动。

点击右下角按钮进行下一回合，并观看游戏 AI 的移动。

每个单元有三个属性值：生命力、攻击力、移动力。

单元生命力小于等于 0 则死亡。

当单元 Ａ 攻击单元 B 时，单元 B 的生命力会减去单元 A 的攻击力，反之依然。当单元 A 攻击血量大于 0 的营地 C 时，营地 C 会受到 A 的攻击，结算方法与单元攻击相同；如营地 C 中包含单元 B ，则单元 B 不会受到伤害，但可给 A 以反击。

不同的地形会影响单元的移动。绿色的草地消耗移动力 2 ，砖地面消耗移动力 1，楼是阻碍地形，不能通过。

游戏可以存档，点击右上角暂停按钮，再点击对应的读档 / 存档，即可存档 / 读档。

游戏以清华大学为背景主题，地图均以清华大学为背景绘制，背景音乐也取材于清华大学日常宣传。

## 图片展示

### 开始界面、游戏界面、地图

<img src="2.gif" alt="2.gif" style="zoom: 25%;" />

### 新建单元、不同角色、单元详细信息

<img src="3.gif" style="zoom:25%;" />

### 移动、攻击、回合制

<img src="1.gif" alt="1.gif" style="zoom:25%;" />

### 胜负判定：全部攻占“营地”

<img src="4.gif" alt="4.gif" style="zoom:25%;" />

### 关卡选择

![](5.gif)

### 游戏存档、读档

![](6.gif)

## 功能实现情况

| 功能要求（50分）                                             | 完成情况                   | 图片概览 |
| ------------------------------------------------------------ | ------------------------- | -------- |
| **界面、交互设计（6分）**                                    | 【6分】 |                                                |
| 标题界面和游戏界面（2分）                                    | 已经实现                           | [见图](#开始界面、游戏界面、地图) |
| 游戏界面可以查看角色和敌人的详细信息（2分）                  | 已经实现                   | [见图](#新建单元、不同角色、单元详细信息) |
| 通过鼠标或键盘实现角色控制以及战斗菜单选择（2分）            | 已经实现                   | [见图](#新建单元、不同角色、单元详细信息) |
| 教程界面或游戏UI说明界面来展示游戏如何操作（1分）            |                            |          |
| **地形设计（4分）**                                          | 【4+1分】 |          |
| 网格状地图（任意规则形状均可，如四边形或六边形）（2分）      | 已经实现，六边形地图 | [见图](#开始界面、游戏界面、地图) |
| 阻挡型地形（角色无法越过）（2分）                            | 已经实现，图中“楼”地形        | [见图](#开始界面、游戏界面、地图) |
| 损伤型地形（角色...损失生命值）（1分）                       |                            |          |
| 妨碍型地形（角色...移动的最大距离减少）（1分）               | 已经实现，图中泥地 | [见图](#开始界面、游戏界面、地图) |
| **敌我方角色设计（11分）**                                   | 【11分】 |          |
| 基本属性：生命值、攻击力、机动性、攻击范围（2分）            | 已经实现，攻击范围均为1，其他均不同 | [见图](#新建单元、不同角色、单元详细信息) |
| 设计至少3种不同特点的角色（9分）                             |  已经实现，双方合计六种角色        | [见图](#新建单元、不同角色、单元详细信息) |
| 其他属性：防御力、技能等设定（4分）                          |                            |          |
| 其他职能角色，如治疗型角色（2分）                            |                            |          |
| 敌方boss型敌人设计（1分）                                    |                            |          |
| **战斗设计（10分）**                                         | 【10分】 |          |
| 回合制机制，每回合每个角色可以各移动和攻击一次（2分）        |    已经实现                        | [见图](#移动、攻击、回合制) |
| 在地图上可视化可移动的范围和可攻击的范围（4分）              | 已经实现                  | [见图](#移动、攻击、回合制) |
| 基本的行动顺序，即一方所有角色行动结束后轮到另一方行动（2分） | 已经实现（但一方可以选择放弃结算）    | [见图](#移动、攻击、回合制) |
| 战斗伤害结算（2分）                                        | 已经实现，被攻击一方 | [见图](#移动、攻击、回合制) |
| 按照敌我方所有角色的行动速度决定行动顺序（1分）              |                            |          |
| 视野：角色在一定距离内才能发现对方角色（3分）                |                                                    |          |
| **关卡设计（6分）**                                    | 【6+1分】 |          |
| 至少设计两个关卡，有不同的地形，角色有不同限制（4分）        | 已经实现 | [见图](#关卡选择) |
| 基本关卡通关判定和失败判定，即敌方全灭或我方全灭（2分）      | 已经实现                           | 见其他通关判定 |
| rogue-like要素，即一定程度内随机生成地形和敌人以及对我方可放置角色种类和数量的限制条件（3分） |                            |          |
| 通过合理设计上一点来使得关卡难度随关卡进行逐渐提高（1分）    |                            |          |
| 其他通关判定方式，如占领特定位置或击败敌方boss（1分）        | 采用了攻占大本营的方式 | [见图](#胜负判定：全部攻占“营地”) |
| **敌方AI设计（4分）**                                        | 【4分】 |          |
| 基本的行动逻辑，即会不断靠近我方角色并发起攻击（4分）        | 已经实现（其实是会靠近大本营，因为胜利条件）[^2] | [见图](#移动、攻击、回合制) |
| 为不同的敌人类型设计不同的行动策略（2分）                    |                            |          |
| 设计不同的难度，难度越高敌方行动逻辑越复杂（2分）            |                            |          |
| **其他要求（9分）**                                          | 【9+2分】 |          |
| 游戏背景音乐、音效（2分）                                    |    已经实现              | 无 |
| 图片素材（请自行寻找）（3分）                                | 已经实现，所有地形和人物均为图片 | 上图均可 |
| 动画效果：角色移动动画、战斗效果等（4分）                    | 已经实现，角色可以沿最短路移动    | [见图](#移动、攻击、回合制) |
| 剧情设计（2分）                                              | 已经实现、疫情防控保卫战 | 无 |
| 战斗复盘（3分）                                              | 可以存档 | [见图](#游戏存档、读档) |

> 功能要求包含基本要求和提高要求，完成基本要求就可以最高得到 50 分，完成提高要求有额外加分，但需要注意，提高要求会根据完成度和质量进行赋分，分值不会超过该项的分数。另外，额外加分仅仅作用于大作业本身分数。加分不会使大作业本身分数突破限制，即当大作业本身分数超过 100 分时，在总成绩计算中大作业按 100 分进入加权计算。

## 代码实现情况

| 代码要求（20分）【20分】                                | 实现情况 | 具体阐述或图片佐证                                           |
| ------------------------------------------------------- | -------- | ------------------------------------------------------------ |
| 要求使用C++和QT进行编写。                               | 是的     |                                                              |
| 要求使用面向对象的编程思想（5分）                       | 已经实现 | 大量继承 `QObject` ，并且图形界面采用对一个图形对象就新产生一个类。 |
| 代码应当有统⼀的风格（4分）                             | 已经实现 | 在代码样貌上，采用 `clang-format` 统一代码风格；在命名上，采用驼峰命名法。 |
| 代码应当包含必要的注释（4分）                           | 已经实现 | 对绝大多数函数均进行了必要的阐述，对较长的函数或判断语句也有必要的说明。 |
| 代码应该合理设计类之间的关系以保证类的良好封装性（2分） | 已经实现 | 如下图所示。                                                 |
| 程序应当拥有较高的运行效率（5分）                       | 已经实现 | 整体流畅运行。[^1]                                           |

## 文档实现情况

| 文档要求（10分）【10分】   | 完成状况                                |
| -------------------------- | --------------------------------------- |
| （你的文档应该包括）       |                                         |
| 各个程序模块之间的逻辑关系 | 已经完成，见[本文下一节](#游戏技术路线) |
| 程序运行的主要流程         | 已经完成，见[游戏流程](#游戏流程)       |
| 简要说明各个功能的演示方法 | 已经完成，见[图片展示](#图片展示)       |
| 参考文献或引用代码出处     | 已经完成，见[参考](#参考)               |
| 文档简洁，清晰易懂         | 已经完成，长度适中，格式良好，图文并茂  |

> 请在文档中清晰有条理地说明你的项目达到了哪些要求，助教将根据文档中出现的内容结合你的可执行文件进行评分。对你所实现的新创意，也请在文档中进行阐述。

## 游戏技术路线

游戏图形采用 Qt 5.15.2 中的 Graphics Framework 搭建，同时也在某些页面使用了 `ui form` 进行图形界面设计。

游戏采用了面向对象的编程方法，类的构造结构大致如下。

为了构造一局游戏，有四种类会被创造出来：

1. 总体管理游戏，沟通游戏逻辑、游戏图形界面。这种包括：`Game` 类、`GraphView` 类。
2. 创建、管理图形界面，接收并判断用户图形界面输入指令的合法性，并通过图形化的方法给出游戏运行的结果。这种包括：`Field` 类，`Block`类，`Unit` 类。
3. 创建、计算游戏逻辑，接收图形界面给出的游戏指令，计算得到游戏局面状态的变化。这种包括：`GraphField` 类，`GraphBlock`类，`GraphUnit` 类。
4. 管理游戏数据，提供给以上 2 和 3 使用计算、绘图等，并且由 1 负责管理。这种包括：`UnitStatus` 类，`BlockStatus` 类。

为了更清晰的说明以上逻辑，以下是程序大致的执行顺序：

![](general.jpg)

## 其他亮点

游戏某一关几乎所有的参数、地图、贴图信息均存储在 `json` 文件中，便于修改。

因此游戏也支持了存档和读档功能，之后如要扩展到多关也非常轻松。

游戏采用的 Qt Graphics Framework，可以轻易地支持地图的扩展和异形地图，这是绝大多数其他实现方法都无法实现的，让游戏具有更加丰富的可能。

游戏的移动和攻击设置十分人性化。

游戏预留了一些改进方向，例如底层的 `unitinfo` 都是以指针形式存储，可以在游戏单元内直接更改；这是为游戏政策树单元预留，可并没有充足的时间实现这一功能。

## 改进方向

游戏的美工做的很丑。

游戏的内存管理进行十分仓促。因此偶尔还会有出错的时候

游戏的性能不够优秀，还是会占用过多的资源。这点比较难以改进，主要是研究一下 Qt 绘图模块缓存的情况

游戏的架构存在一定的冗余（是在写完代码之后才发现的），`Block` 类和 `Unit` 类是可以与 `BlockStatus` 类与 `UnitStatus` 类合并的，将 `Field` 类和 `GraphField` 类并列与格、单元的数据层之上。

游戏的代码较长，不知道怎么就写了3000行，但并没有写了不到两千行的同学美工做的好。

游戏的 AI 策略比较愚蠢，游戏缺少双人对战和网络对战功能。

## 参考

参考的网络代码具体来源已经在代码注释中注明。

主要有以下几个部分采用了网络代码：

1. Qt Json 文件的读取
2. Qt GraphView 类的滚轮缩放和拖动技术
3. Qt Gif 在 GraphScene 中的播放和自动更新

[^1]: 因为技术路线（采用 Qt Graphics Framework）的缘故，再加上游戏的资源分辨率和清晰度很高，在动图更新重绘的成本会很高，所以运行时内存占用和 CPU 占用会很高。但考虑到其作者的轻薄本上也能够流畅运行，所以作者认为这个程序的运行效率是可以算高的。

[^2]: 具体的实现方法是写了一个估值函数、综合敌方兵和营地的位置距离该单元的远近给出一个数值，数值越大越靠近敌方单元格，单元每次在能够到达单元格里选择该值最大的单元格进行移动。

